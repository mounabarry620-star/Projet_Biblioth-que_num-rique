#!/usr/bin/expect

# ==============================================================================
# CONFIGURATION
# ==============================================================================
# On laisse un peu de temps au programme pour répondre (5 secondes max)
set timeout 5
set db_file "library.db"
set csv_file "livres-lot-2.csv"

# 1. On nettoie tout pour commencer le test sur une base propre
exec rm -f $db_file
exec rm -f catalogue.html

# 2. On génère un fichier CSV pour tester l'importation
# On calcule l'année pour avoir toujours 4 chiffres (ex: 2011, 2012...)
set csv_content "ISBN;Titre;Langue;Auteurs;Date;Genre;Description\n"
for {set i 1} {$i <= 15} {incr i} {
    set annee [expr 2010 + $i]
    append csv_content "978-LOT-$i;Livre du Lot Numero $i;FR;Auteur $i;01/01/$annee;Test;Description du livre $i\n"
}

# On écrit le contenu dans le fichier
set f [open $csv_file w]
puts $f $csv_content
close $f

# ==============================================================================
# PHASE 1 : PREMIER LANCEMENT ET GESTION D'ERREUR
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 1\] INITIALISATION ET TEST D'ERREURS ===\033\[0m"
spawn ./app

# --- On remplit le formulaire de départ ---
expect "Nom de votre bibliothèque"
send "Médiathèque du Test Ultime\r"
expect "Description"
send "Validation complète du projet.\r\r" 
expect "Appuyez 2 fois sur Entrée"
send "\r\r"

# --- On teste si l'appli rejette une date invalide ---
puts "\n>> Test : On essaie de mettre une mauvaise date..."
expect "> Votre choix :"
send "2\r"
# Menu Gérer
expect "> Votre choix :"
send "1\r"
# Ajouter un livre
expect "ISBN"
send "978-FAIL-001\r"
expect "Titre"
send "Livre Erreur\r"
expect "Langue"
send "FR\r"
expect "Auteurs"
send "Personne\r\r"
expect "Date"
send "99/99/2022\r" 
# L'appli doit dire "Erreur"
expect "Erreur"
# On corrige avec une bonne date
send "01/01/2022\r"
expect "Genre"
send "Erreur\r"
expect "Description"
send "Ce livre ne doit pas être sauvegardé.\r\r"
expect "Appuyez sur Entrée"
send "\r"

# --- On quitte SANS sauvegarder pour voir si ça marche ---
puts "\n>> Test : On quitte sans sauvegarder..."
# On retourne au menu principal d'abord
expect "> Votre choix :"

send "4\r" 
expect "> Votre choix :"
send "6\r"
# Le programme doit nous avertir !
expect "MODIFICATIONS NON ENREGISTRÉES"
expect "> Choix :"
send "2\r" 
# Choix 2 = Quitter sans sauvegarder
expect eof

# ==============================================================================
# PHASE 2 : IMPORTATION ET VÉRIFICATION
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 2\] VERIFICATION ET IMPORTATION ===\033\[0m"
# On relance le programme.
spawn ./app

# On vérifie que le "Livre Erreur" a bien disparu
expect "> Votre choix :"
send "1\r"
# Consulter
expect "Aucun livre"
send "\r"
puts ">> Validation OK : Le livre non sauvegardé a bien disparu."

# --- On importe le fichier CSV qu'on a créé au début ---
expect "> Votre choix :"
send "2\r" 
# Menu Gérer
expect "> Votre choix :"
send "2\r"
# Importer
expect "Nom du fichier CSV"
send "$csv_file\r"
expect "Succès !"
expect "Appuyez sur Entrée"
send "\r"
# Retour au menu principal
expect "> Votre choix :"
send "4\r"

# --- On change les paramètres (Pagination et Logo) ---
puts "\n>> Test : Modification des paramètres..."
expect "> Votre choix :"
send "5\r"
# Menu Paramètres
expect "> Votre choix :"
send "2\r"
# Changer nombre de livres par page
expect "Nombre de livres par page"
send "5\r" 
# On met 5 pour tester les pages
expect "> Votre choix :"
send "3\r"
# Modifier le Logo
expect "Choix"
send "1\r"
# Saisie manuelle
expect "Entrez votre nouveau logo"
send "  *** TEST *** \r\r"
expect "Nouveau logo enregistré"
send "\r"
expect "> Votre choix :"
send "4\r" 
# Retour Menu Principal

# ==============================================================================
# PHASE 3 : NAVIGATION (PAGES)
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 3\] TEST DE LA NAVIGATION (Suivant/Précédent) ===\033\[0m"
expect "> Votre choix :"
# On vérifie que notre logo "TEST" s'affiche bien
expect "TEST" 
send "1\r"
# Consulter

# Page 1 (Livres 1 à 5)
expect "Page 1"
expect "Livre du Lot Numero 1"
send "s\r"

# Page 2 (Livres 6 à 10)
expect "Page 2"
expect "Livre du Lot Numero 6"
expect "Page précédente" 
send "s\r"

# Page 3 (Livres 11 à 15)
expect "Page 3"
expect "Livre du Lot Numero 15"
send "p\r"

# Retour Page 2
expect "Page 2"
send "p\r"

# Retour Page 1
expect "Page 1"
send "q\r"

# ==============================================================================
# PHASE 4 : RECHERCHE
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 4\] TEST DE LA RECHERCHE ===\033\[0m"
expect "> Votre choix :"
send "3\r"
expect "> Choix :"
send "1\r"
# Recherche par ISBN
expect "recherche"
send "978-LOT-7\r"
expect "RÉSULTATS"
expect "Livre du Lot Numero 7"
send "q\r"

# ==============================================================================
# PHASE 5 : EXPORT HTML
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 5\] EXPORT HTML ===\033\[0m"
expect "> Votre choix :"
send "4\r"
expect "Export terminé"
expect "Appuyez sur Entrée"
send "\r"

# ==============================================================================
# PHASE 6 : AJOUT FINAL ET SAUVEGARDE
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 6\] SAUVEGARDE AVANT DE QUITTER ===\033\[0m"
expect "> Votre choix :"
send "2\r"
# Menu Gérer
expect "> Votre choix :"
send "1\r"
# Ajouter un dernier livre manuellement
expect "ISBN"
send "978-FINAL\r"
expect "Titre"
send "Livre Final\r"
expect "Langue"
send "FR\r"
expect "Auteurs"
send "Moi\r\r"
expect "Date"
send "01/01/2023\r"
expect "Genre"
send "Fin\r"
expect "Description"
send "C'est la fin.\r\r"
expect "Appuyez sur Entrée"
send "\r"

# Retour au menu principal
expect "> Votre choix :"
send "4\r"

# On quitte l'application (Choix 6)
expect "> Votre choix :"
send "6\r"
# Le programme voit qu'on a ajouté un livre, il doit demander de sauvegarder
expect "MODIFICATIONS NON ENREGISTRÉES"
expect "> Choix :"
send "1\r" 
# Choix 1 = Sauvegarder et quitter
expect "Sauvegarde effectuée"
expect "Au revoir"
expect eof

# ==============================================================================
# PHASE 7 : VERIFICATION PERSISTANCE ET SECURITE PARAMETRES
# ==============================================================================
puts "\n\033\[1;34m=== \[PHASE 7\] VERIFICATION FINALE ET PARAMETRES ===\033\[0m"
# On relance une dernière fois
spawn ./app

expect "> Votre choix :"
send "1\r"
# Consulter
expect "Livre Final"
puts ">> Validation OK : Le dernier livre est bien resté en mémoire."
# On sort de la consultation (il faut faire q, parfois plusieurs pages)
send "q\r" 
# Si on est sur la page 1, q suffit.

# --- Test du piège dans les paramètres ---
puts "\n>> Test : Modification du Titre et tentative de fuite..."
expect "> Votre choix :"
send "5\r"
# Menu Paramètres
expect "> Votre choix :"
send "1\r"
# Modifier le Titre
expect "Titre actuel"
send "Bibliotheque MODIFIEE\r"
expect "Description actuelle"
send "\r"
# On ne change pas la description
expect "Appuyez sur Entrée"
send "\r"

# ATTENTION : On essaie de quitter DIRECTEMENT depuis les paramètres (Choix 5)
expect "> Votre choix :"
send "5\r"
# Le programme doit nous bloquer !
expect "MODIFICATIONS NON ENREGISTRÉES"
expect "> Choix :"
send "1\r"
# On sauvegarde et on part
expect "Sauvegarde effectuée"
expect "Au revoir"
expect eof

puts "\n\n\033\[1;32m--- \[SUCCÈS\] TOUS LES TESTS SONT PASSÉS ! BRAVO ! ---\033\[0m\n"

# On supprime le fichier CSV de test pour laisser le dossier propre
exec rm -f $csv_file